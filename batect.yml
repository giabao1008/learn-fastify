containers:
    my-container:
        image: alpine:3.16.2
    build-fastify-env:
        image: node:14.17.4
        volumes:
            - local: .
              container: /code
              options: cached
            - type: cache
              name: node_modules
              container: /code/node_modules
        working_directory: /code

    # postgres sql container
    db:
        image: postgres:14.3
        environment:
            POSTGRES_PASSWORD: password
            POSTGRES_USER: app
            POSTGRESS_DB: db
            #POSTGRES_HOST_AUTH_METHOD: trust
tasks:
    say-hello:
        description: Install dependencies needed to build and run the application
        run:
            container: my-container
            command: echo 'Hello world!'

    # task for installiing dep of fastify app
    install-dep:
        description: Install dependencies needed to build fastify application
        run:
            container: build-fastify-env
            command: npm install

    # task for running fastify app
    start-server:
        description: Run fastify application
        run:
            environment:
                PORT: 8000
                POSTGRES_URI: postgres://app:password@db/db
            container: build-fastify-env
            command: npm run start
            ports:
                - 5000:8000
        dependencies:
            - db
